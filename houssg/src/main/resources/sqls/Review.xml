<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ssg.com.houssg.dao.ReviewDao">
	<insert id="addReview" parameterType="ssg.com.houssg.dto.ReviewDto">
	    INSERT INTO review(review_content,review_rating,review_creation_time,report_status, id, reservation_number,room_number,accom_number,img) 
	    VALUES (#{reviewContent}, #{reviewRating}, NOW() , 0, #{id},#{reservationNumber}, #{roomNumber}, #{accomNumber},#{img})
	</insert>

	<select id="getMyReview" parameterType="java.lang.String" resultType="ssg.com.houssg.dto.ReviewDto">
		SELECT r.review_number, r.review_content, r.review_creation_time, r.review_comment, r.review_comment_time, r.img, r.manager_id, ro.room_category, ro.room_number, a.accom_name, u.nickname
		FROM review r
		JOIN user u ON r.id = u.id
		JOIN rooms ro ON r.room_number = ro.room_number
		JOIN accommodation a ON r.accom_number = a.accom_number
		WHERE u.id = #{id} AND r.report_status=0
	</select>
	
	<select id="getAllReview" parameterType="java.lang.Integer" resultType="ssg.com.houssg.dto.ReviewDto">
	    SELECT r.*, ro.room_category
	    FROM review r 
	    JOIN rooms ro ON r.room_number = ro.room_number
	    WHERE r.room_number = #{roomNumber} AND r.accom_number = #{accomNumber} AND r.report_status=0
	    ORDER BY r.review_creation_time DESC
	</select>
	
	<update id="updateReview" parameterType="java.lang.Integer">
		UPDATE review 
		SET	report_status=1
		WHERE review_number=#{reviewNumber} and room_number=#{roomNumber} and accom_number = #{accomNumber}
	</update>
	
	<delete id="deleteReview" parameterType="java.lang.Integer">
	    DELETE FROM review
	    WHERE review_number = #{reviewNumber} and report_status = 1
	</delete>
	
	<select id="getAuthReview" resultType="ssg.com.houssg.dto.ReviewDto">
		SELECT *
		FROM review 
		WHERE report_status = 1
	</select>
	
	<update id="addComment" parameterType="ssg.com.houssg.dto.ReviewDto">
	    UPDATE review AS r
	    INNER JOIN accommodation AS a ON r.accom_number = a.accom_number
	    SET r.review_comment = #{reviewComment}, r.review_comment_time = now(), r.manager_id = a.id
	    WHERE r.review_number = #{reviewNumber}
	      AND r.reservation_number = #{reservationNumber}
	      AND r.accom_number = a.accom_number
	      AND r.manager_id = a.id
	</update>
	
	<update id="updateComment" parameterType="ssg.com.houssg.dto.ReviewDto">
	    UPDATE review AS r
	    INNER JOIN accommodation AS a ON r.accom_number = a.accom_number
	    SET
	    r.review_comment = #{reviewComment},
	    r.review_comment_time = now()
	    WHERE r.review_number = #{reviewNumber}
	      AND r.reservation_number = #{reservationNumber}
	      AND r.accom_number = a.accom_number
	      AND r.manager_id = a.id
</update>


</mapper>